# Default task list
#
# Copyright 2025 林博仁(Buo-ren Lin) <buo.ren.lin@gmail.com>
# SPDX-License-Identifier: CC-BY-SA-4.0

- name: >-
    Use Taiwan local Ubuntu mirror to reduce package download time.
  # NOTE: Ubuntu >=24.04 uses the DEP822 software source format, which
  # isn't compatible with the chusiang.switch-apt-mirror role at the
  # moment
  when: >-
    ansible_distribution_file_variety == "Debian"
      and (
        ansible_distribution == "Ubuntu"
          and ansible_distribution_version < "24.04"
      )
  vars:
    ubuntu_apt_mirror: tw.archive.ubuntu.com
  ansible.builtin.include_role:
    name: chusiang.switch-apt-mirror
    apply:
      become: true

- name: Ensure that the software repository local cache is fresh
  ansible.builtin.import_tasks: ensure-software-repository-local-cache-is-fresh.yml

- name: Apply system updates to avoid known issues.
  when: not brlinos_skip_upgrade
  become: true
  ansible.builtin.package:
    # We specifically intend to upgrade all packages here
    # noqa package-latest
    name: '*'
    state: latest

- name: Deploy preferred software.
  when: not brlinos_skip_software_installation
  ansible.builtin.import_tasks: deploy-preferred-software.yml

- name: Making libvirt bridge interfaces not managed by NetworkManager.
  become: true
  notify:
    - Apply udev rule changes
    - Reload NetworkManager configuration
  ansible.builtin.copy:
    src: udev.rules.d/dont-manage-libvirt-managed-bridges.rules
    dest: /etc/udev/rules.d/85-nm-unmanaged-libvirt.rules
    owner: root
    group: root
    mode: '0644'

- name: Making Multipass bridge interfaces not managed by NetworkManager.
  become: true
  notify:
    - Apply udev rule changes
    - Reload NetworkManager configuration
  ansible.builtin.copy:
    src: udev.rules.d/dont-manage-multipass-qemu-bridges.rules
    dest: /etc/udev/rules.d/85-nm-unmanaged-multipass.rules
    owner: root
    group: root
    mode: '0644'

- name: >-
    Making virtual ethernet device(veth) interfaces not managed by
    NetworkManager
  become: true
  notify:
    - Reload NetworkManager configuration
  ansible.builtin.copy:
    src: NetworkManager.conf.d/90-unmanage-virtual-ethernet-network-interfaces.conf
    dest: /etc/NetworkManager/conf.d/90-unmanage-virtual-ethernet-network-interfaces.conf
    owner: root
    group: root
    mode: '0644'

- name: Workaround lack of support for garbage collect operations(DISCARD/UNMAP/TRIM) on flash storage drives over the USB protocol
  when: brlinos_apply_flash_storage_workarounds
  become: true
  notify:
    - Apply udev rule changes
  ansible.builtin.copy:
    src: udev.rules.d/workaround-no-unmap-support-on-flash-memory-drives-over-usb.rules
    dest: /etc/udev/rules.d/90-workaround-no-unmap-support-on-flash-memory-drives-over-usb.rules
    owner: root
    group: root
    mode: '0644'

- name: Cleanup customizations from old versions of the playbook.
  ansible.builtin.import_tasks: cleanup.yml

- name: Reboot.
  when: ansible_connection != "local"
  become: true
  ansible.builtin.reboot:

- name: Report final result.
  ansible.builtin.debug:
    msg: Customization finished, if the playbook is run on the localhost please reboot the system to apply modifications.
